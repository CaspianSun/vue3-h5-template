import config from '@/config'
import jsSHA1 from 'jssha/dist/sha1'
import {
  getWeChatAccessToken,
  getWeChatJsApiTicket
} from '@/api/weChatOpenTest'
import { showFailToast } from 'vant'

enum LocalName {
  storeAccessTokenName = 'WE_CHAT_ACCESS_TOKEN',
  jsApiTicketName = 'WE_CHAT_JS_API_TICKET'
}

class WeChatOpenTest {
  constructor() {
    if (!config.weChatOpenTest || !config.testAppId || !config.testAppSecret) {
      showFailToast('请正确配置微信开放平台相关信息')
      throw new Error('请正确配置微信开放平台相关信息')
    }
    this._init()
  }
  private _init() {
    if (config.weChatOpenTest) {
      this._setWeChatOpenTest()
    }
    return
  }
  private async _setWeChatOpenTest() {
    const { testAppId, testAppSecret } = config
    const timestamp = Math.round(new Date().getTime() / 1000).toString()
    const nonceStr = 'Wm3WZYTPz0wzccnW'
    const signature = await this._generateJsApiTicket(
      testAppId,
      testAppSecret,
      nonceStr,
      timestamp
    )
    if (!signature) return
    window.wx.config({
      debug: false,
      appId: testAppId,
      timestamp: timestamp,
      nonceStr: nonceStr,
      signature: signature,
      jsApiList: ['checkJsApi', 'onMenuShareTimeline', 'onMenuShareAppMessage'],
      beta: false
    })
  }
  private async _generateJsApiTicket(
    testAppId: string,
    testAppSecret: string,
    nonceStr: string,
    timestamp: string
  ) {
    const url = window.location.href.split('#')[0]
    const accessToken = await this._getAccessToken(testAppId, testAppSecret)
    if (!accessToken) return
    const jsapi_ticket = await this._getJsApiTicket(accessToken)
    if (!jsapi_ticket) return
    const shaObj = new jsSHA1('SHA-1', 'TEXT', { encoding: 'UTF8' })
    shaObj.update(
      `jsapi_ticket=${jsapi_ticket}&noncestr=${nonceStr}&timestamp=${timestamp}&url=${url}`
    )
    const sha = shaObj.getHash('HEX')
    console.log('sha', sha)
    return sha
  }
  private async _getAccessToken(testAppId: string, testAppSecret: string) {
    let accessToken = localStorage.getItem(LocalName.storeAccessTokenName)
    if (!accessToken) {
      const { access_token } = await getWeChatAccessToken(
        testAppId,
        testAppSecret
      )
      if (access_token) {
        localStorage.setItem(LocalName.storeAccessTokenName, access_token)
        localStorage.removeItem
        accessToken = access_token
      } else {
        showFailToast('accessToken获取失败')
        throw new Error('accessToken获取失败')
      }
    }
    return accessToken
  }
  private async _getJsApiTicket(accessToken: string) {
    let jsApiTicket = localStorage.getItem(LocalName.jsApiTicketName)
    if (!jsApiTicket) {
      const { errcode, ticket } = await getWeChatJsApiTicket(accessToken)
      if (errcode == 0 && ticket) {
        localStorage.setItem(LocalName.jsApiTicketName, ticket)
        jsApiTicket = ticket
      } else {
        showFailToast('jsApiTicket获取失败')
        throw new Error('jsApiTicket获取失败')
      }
    }
    return jsApiTicket
  }
}
export default WeChatOpenTest
